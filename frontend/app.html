<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MetaMask Connect (ethers v6)</title>
  <!-- ë¸Œë¼ìš°ì € ì „ì—­ ethers ê°ì²´ ìƒì„± -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
</head>
<body  style="text-align: center;">
  <h2>MetaMask ì—°ê²° ë°ëª¨</h2>
  <button id="connectButton">ğŸ”— MetaMask ì—°ê²°</button>
  <p id="accountInfo"></p>

  <h2>ğŸ¦ SimpleBank ìƒí˜¸ì‘ìš©</h2>
  <button id="depositButton">ğŸ’° ì…ê¸ˆ (0.01 ETH)</button><br><br>

  <input type="number" id="withdrawAmt" placeholder="ì¶œê¸ˆí•  ê¸ˆì•¡ (ETH)">
  <button id="withdrawButton">ğŸ§ ì¶œê¸ˆ</button><br><br>

  <button id="checkBalance">ğŸ“Š ë‚´ ì”ì•¡ í™•ì¸</button><br><br>

  <button id="checkEth">ğŸ’  ì§€ê°‘ ETH ì”ì•¡ í™•ì¸</button><br><br>
  <button id="checkMyBalance">ğŸ¦ myBalance() ì¡°íšŒ</button>

  <p id="balanceInfo"></p>
  <p id="myBalanceInfo"></p>
  <hr width = "90%">

  <h2>ğŸª™ SimpleBankV2 (ETH + Token)</h2>

  <!-- ETH ì…ì¶œê¸ˆ -->
  <button id="v2DepositEth">ğŸ’° ETH ì…ê¸ˆ (0.01)</button><br><br>
  <input type="number" id="v2WithdrawEthAmt" placeholder="ETH ì¶œê¸ˆ ê¸ˆì•¡">
  <button id="v2WithdrawEth">ğŸ§ ETH ì¶œê¸ˆ</button><br><br>

  <!-- ERC-20 ì…ì¶œê¸ˆ -->
  <input type="number" id="v2TokenAmt" placeholder="í† í° ì…ê¸ˆ ê¸ˆì•¡">
  <button id="v2ApproveToken">âœ… í† í° ìŠ¹ì¸</button>
  <button id="v2DepositToken">ğŸ“¥ í† í° ì…ê¸ˆ</button><br><br>

  <input type="number" id="v2WithdrawTokenAmt" placeholder="í† í° ì¶œê¸ˆ ê¸ˆì•¡">
  <button id="v2WithdrawToken">ğŸ“¤ í† í° ì¶œê¸ˆ</button><br><br>

  <!-- ì”ì•¡ ì¡°íšŒ -->
  <button id="v2CheckEth">ğŸ’  ETH ì”ì•¡ í™•ì¸</button>
  <button id="v2CheckToken">ğŸª™ Token ì”ì•¡ í™•ì¸</button>

  <p id="v2EthInfo"></p>
  <p id="v2TokenInfo"></p>

<script type="module">
  const contractAddress = '0x5FbDB2315678afecb367f032d93F642f64180aa3';
  const res = await fetch('./abi/SimpleBank.json');
  const contractABI = (await res.json()).abi;
  
  const tokenAddress = '0xDc64a140Aa3E981100a9becA4E685f962f0cF6C9';
  const resToken = await fetch('./abi/MyToken.json');
  const abiToken = (await resToken.json()).abi;

  const contractV2Address = '0x5FC8d32690cc91D4c39d9d3abcBD16989F875707';
  const resV2 = await fetch('./abi/SimpleBankV2.json');
  const abiV2 = (await resV2.json()).abi;



  let provider, signer, contract, contractV2, myToken;

  const connectBtn     = document.getElementById('connectButton');
  const depositBtn     = document.getElementById('depositButton');
  const withdrawBtn    = document.getElementById('withdrawButton');
  const checkBalanceBtn = document.getElementById('checkBalance');

  const accountInfo    = document.getElementById('accountInfo');
  const balanceInfo    = document.getElementById('balanceInfo');


  connectBtn.onclick = async () => {
    provider = new ethers.BrowserProvider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = await provider.getSigner();
    const address = await signer.getAddress();
    contract = new ethers.Contract(contractAddress, contractABI, signer);
    contractV2 = new ethers.Contract(contractV2Address, abiV2, signer);
    myToken = new ethers.Contract(tokenAddress, abiToken, signer);

    accountInfo.textContent = `âœ… ì—°ê²°ëœ ì£¼ì†Œ: ${address}`;
  };

  depositBtn.onclick = async () => {
    try {
      const tx = await contract.deposit({ value: ethers.parseEther("0.01") });
      await tx.wait();
      alert("ğŸ’° ì…ê¸ˆ ì™„ë£Œ!");
    } catch (err) {
      alert("âŒ ì…ê¸ˆ ì‹¤íŒ¨: " + err.message);
    }
  };

  withdrawBtn.onclick = async () => {
    try {
      const amount = document.getElementById('withdrawAmt').value;
      if (!amount || isNaN(amount) || Number(amount) <= 0) {
        alert("ì¶œê¸ˆí•  ê¸ˆì•¡ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      const tx = await contract.withdraw(ethers.parseEther(amount));
      await tx.wait();
      alert("ğŸ§ ì¶œê¸ˆ ì™„ë£Œ!");
    } catch (err) {
      alert("âŒ ì¶œê¸ˆ ì‹¤íŒ¨: " + err.message);
    }
  };

  checkBalanceBtn.onclick = async () => {
    try {
      const addr = await signer.getAddress();
      const bal = await contract.balanceOf(addr);
      balanceInfo.textContent = `ğŸ“Š í˜„ì¬ ì”ì•¡: ${ethers.formatEther(bal)} ETH`;
    } catch (err) {
      alert("ì”ì•¡ ì¡°íšŒ ì‹¤íŒ¨: " + err.message);
    }
  };

  /* â¶ ì§€ê°‘ ETH ì”ì•¡ í™•ì¸ */
document.getElementById('checkEth').onclick = async () => {
  try {
    const addr = await signer.getAddress();
    const ethBal = await provider.getBalance(addr);           // ë„¤ì´í‹°ë¸Œ ETH
    alert(`ì§€ê°‘ ì£¼ì†Œ ë‚´ ì”ì•¡: ${ethers.formatEther(ethBal)} ETH`);
  } catch (err) {
    alert("ETH ì”ì•¡ ì¡°íšŒ ì‹¤íŒ¨: " + err.message);
  }
};

  /* â· myBalance() í˜¸ì¶œ */
  document.getElementById('checkMyBalance').onclick = async () => {
    try {
      const bal = await contract.myBalance();                   // view í•¨ìˆ˜
      document.getElementById('myBalanceInfo').textContent =
        `ğŸ¦ ì»¨íŠ¸ë™íŠ¸ ë³´ê´€ ì”ì•¡: ${ethers.formatEther(bal)} ETH`;
    } catch (err) {
      alert("myBalance ì¡°íšŒ ì‹¤íŒ¨: " + err.message);
    }
  };

  //--------------------------------Contract V2 Interaction--------------------------------

  // V2: ETH ì…ê¸ˆ
  document.getElementById('v2DepositEth').onclick = async () => {
    const tx = await contractV2.deposit({ value: ethers.parseEther("0.01") });
    await tx.wait();
    alert("ETH ì…ê¸ˆ ì™„ë£Œ");
  };

  // V2: ETH ì¶œê¸ˆ
  document.getElementById('v2WithdrawEth').onclick = async () => {
    const amt = document.getElementById('v2WithdrawEthAmt').value;
    const tx = await contractV2.withdraw(ethers.parseEther(amt));
    await tx.wait();
    alert("ETH ì¶œê¸ˆ ì™„ë£Œ");
  };

  // V2: í† í° ìŠ¹ì¸
  document.getElementById('v2ApproveToken').onclick = async () => {
    const amt = document.getElementById('v2TokenAmt').value;
    const tx = await myToken.approve(contractV2Address, ethers.parseEther(amt));
    await tx.wait();
    alert("âœ… ìŠ¹ì¸ ì™„ë£Œ");
  };

  // V2: í† í° ì…ê¸ˆ
  document.getElementById('v2DepositToken').onclick = async () => {
    const amt = document.getElementById('v2TokenAmt').value;
    const tx = await contractV2.depositToken(ethers.parseEther(amt));
    await tx.wait();
    alert("ğŸ“¥ í† í° ì…ê¸ˆ ì™„ë£Œ");
  };

  // V2: í† í° ì¶œê¸ˆ
  document.getElementById('v2WithdrawToken').onclick = async () => {
    const amt = document.getElementById('v2WithdrawTokenAmt').value;
    const tx = await contractV2.withdrawToken(ethers.parseEther(amt));
    await tx.wait();
    alert("ğŸ“¤ í† í° ì¶œê¸ˆ ì™„ë£Œ");
  };

  // V2: ETH ì”ì•¡ ì¡°íšŒ
  document.getElementById('v2CheckEth').onclick = async () => {
    const addr = await signer.getAddress();
    const bal = await contractV2.ethBalanceOf(addr);
    document.getElementById('v2EthInfo').textContent = `ğŸ’  ì»¨íŠ¸ë™íŠ¸ ì† ETH: ${ethers.formatEther(bal)} ETH`;
  };

  // V2: Token ì”ì•¡ ì¡°íšŒ
  document.getElementById('v2CheckToken').onclick = async () => {
    const addr = await signer.getAddress();
    const bal = await contractV2.tokenBalanceOf(addr);
    document.getElementById('v2TokenInfo').textContent = `ğŸª™ ì»¨íŠ¸ë™íŠ¸ ì† í† í°: ${ethers.formatEther(bal)} DTK`;
  };
</script>
</body>
</html>
